<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* SCROLLBAR & GLOBAL STYLES */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #18181b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }
        body { font-family: 'Inter', sans-serif; background-color: #09090b; color: #e4e4e7; user-select: none; overflow: hidden; }
        .drag-handle { -webkit-app-region: drag; }
        .no-drag { -webkit-app-region: no-drag; }
        .animate-pulse-short { animation: pulse 1.5s ease-in-out infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body class="h-screen flex flex-col border border-zinc-800 rounded-lg overflow-hidden">

    <!-- TITLE BAR -->
    <div class="h-10 bg-zinc-900 flex items-center justify-between px-4 border-b border-zinc-800 drag-handle">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-cloud-arrow-down text-indigo-500"></i>
            <span class="text-sm font-medium">YT Downloader</span>
        </div>
        <div class="flex items-center gap-4 no-drag">
            <button onclick="pywebview.api.minimize_window()" class="text-zinc-500 hover:text-white"><i class="fa-solid fa-minus"></i></button>
            <button onclick="pywebview.api.close_window()" class="text-zinc-500 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
        </div>
    </div>

    <!-- CONTENT -->
    <div class="flex flex-1 overflow-hidden">
        <!-- SIDEBAR -->
        <aside class="w-[360px] bg-zinc-900 flex flex-col border-r border-zinc-800 p-6 gap-5 overflow-y-auto">
            
            <!-- Inputs -->
            <div>
                <label class="text-xs font-bold text-zinc-500 uppercase mb-2 block">URL</label>
                <div class="flex gap-2">
                    <input type="text" id="url-input" placeholder="Paste link..." class="w-full bg-zinc-800 border border-zinc-700 rounded-lg py-2 px-3 text-sm focus:border-indigo-500 outline-none">
                </div>
            </div>

            <div>
                <label class="text-xs font-bold text-zinc-500 uppercase mb-2 block">Save To</label>
                <div class="flex gap-2">
                    <input type="text" id="path-input" readonly class="w-full bg-zinc-800 border border-zinc-700 rounded-lg py-2 px-3 text-sm text-zinc-400 cursor-default">
                    <button onclick="pywebview.api.select_folder().then(p => { if(p) document.getElementById('path-input').value = p; })" class="bg-zinc-800 border border-zinc-700 hover:bg-zinc-700 text-white rounded-lg px-3 py-2 transition">
                        <i class="fa-solid fa-ellipsis"></i>
                    </button>
                </div>
            </div>

            <!-- Settings -->
            <div class="bg-[#202023] p-4 rounded-xl border border-zinc-800 space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-sm">Separate Folder</span>
                    <input type="checkbox" id="chk-folder" class="accent-indigo-500 w-4 h-4">
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm">Convert to MP4</span>
                    <input type="checkbox" id="chk-mp4" checked class="accent-indigo-500 w-4 h-4">
                </div>
            </div>

            <button onclick="initiateDownload()" class="mt-auto w-full bg-indigo-600 hover:bg-indigo-500 text-white font-medium py-3 rounded-xl transition shadow-lg shadow-indigo-500/20 flex justify-center items-center gap-2">
                <i class="fa-solid fa-download"></i> Download
            </button>
        </aside>

        <!-- QUEUE -->
        <main class="flex-1 bg-black flex flex-col p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Queue</h2>
                <button onclick="clearAll()" class="text-xs text-zinc-500 hover:text-white">Clear All</button>
            </div>
            
            <div id="download-list" class="flex-1 overflow-y-auto space-y-3 pr-2"></div>
        </main>
    </div>

    <script>
        const statusLabels = {
            downloading: 'Downloading...',
            converting: 'Converting...',
            done: 'Completed',
            cancelled: 'Cancelled',
            error: 'Error',
            idle: 'Starting...'
        };

        function clearAll() {
            document.getElementById('download-list').innerHTML = '';
        }

        function initiateDownload() {
            const url = document.getElementById('url-input').value.trim();
            const path = document.getElementById('path-input').value.trim();
            const mp4 = document.getElementById('chk-mp4').checked;
            const separateFolder = document.getElementById('chk-folder').checked;
            
            if(!url) return alert("Please enter a URL");

            pywebview.api.start_download(url, path, {mp4: mp4, separate_folder: separateFolder}).then(res => {
                if(res.status === 'ok') {
                    createTaskCard(res.task_id, url);
                    document.getElementById('url-input').value = '';
                } else {
                    alert("Error: " + res.error);
                }
            });
        }

        function createTaskCard(id, title) {
            const list = document.getElementById('download-list');
            const html = `
            <div id="card-${id}" class="bg-[#18181b] p-4 rounded-xl border border-zinc-800 animate-pulse-short">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 rounded bg-zinc-800 flex items-center justify-center text-indigo-500">
                        <i id="icon-${id}" class="fa-solid fa-video"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="text-sm font-medium text-white truncate" id="title-${id}">${title}</h4>
                        <div class="flex justify-between mt-1">
                            <span id="status-${id}" class="text-xs text-zinc-400">${statusLabels.idle}</span>
                            <span id="percent-${id}" class="text-xs text-indigo-400 font-mono">0%</span>
                        </div>
                    </div>
                </div>
                <div class="w-full bg-zinc-800 h-1.5 rounded-full overflow-hidden">
                    <div id="prog-${id}" class="bg-indigo-600 h-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div class="flex justify-end gap-2 mt-3">
                    <button id="open-${id}" onclick="openResult('${id}')" disabled class="px-3 py-2 rounded-lg text-xs bg-zinc-800 border border-zinc-700 text-zinc-400 cursor-not-allowed">Open Folder</button>
                    <button id="cancel-${id}" onclick="cancelTask('${id}')" class="px-3 py-2 rounded-lg text-xs bg-zinc-800 border border-zinc-700 text-white hover:bg-zinc-700">Cancel</button>
                </div>
            </div>`;
            list.insertAdjacentHTML('afterbegin', html);
        }

        function updateProgress(id, percent) {
            const bar = document.getElementById('prog-' + id);
            const label = document.getElementById('percent-' + id);
            if(bar) bar.style.width = `${Math.min(Math.max(percent, 0), 100)}%`;
            if(label) label.textContent = `${Math.round(percent)}%`;
        }

        function updateStatus(id, statusText) {
            const statusEl = document.getElementById('status-' + id);
            if(statusEl) statusEl.textContent = statusText;
        }

        function setCardState(id, state, info={}) {
            const card = document.getElementById('card-' + id);
            const icon = document.getElementById('icon-' + id);
            const statusEl = document.getElementById('status-' + id);
            const cancelBtn = document.getElementById('cancel-' + id);
            const openBtn = document.getElementById('open-' + id);

            if(!card) return;

            card.classList.remove('animate-pulse-short');
            if(state === 'done') {
                updateProgress(id, 100);
                card.classList.remove('border-zinc-800');
                card.classList.add('border-green-500/40');
                if(statusEl) statusEl.className = 'text-xs text-green-500';
                if(icon) icon.className = 'fa-solid fa-circle-check text-green-500';
                if(openBtn) {
                    openBtn.disabled = false;
                    openBtn.dataset.path = info.path || '';
                    openBtn.classList.remove('cursor-not-allowed', 'text-zinc-400');
                    openBtn.classList.add('text-white', 'border-green-500/40');
                }
                if(cancelBtn) {
                    cancelBtn.disabled = true;
                    cancelBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            } else if(state === 'error') {
                card.classList.remove('border-zinc-800');
                card.classList.add('border-red-500/40');
                if(statusEl) {
                    statusEl.className = 'text-xs text-red-400';
                    statusEl.textContent = info.message || statusLabels.error;
                }
                if(icon) icon.className = 'fa-solid fa-circle-exclamation text-red-400';
                if(cancelBtn) {
                    cancelBtn.disabled = true;
                    cancelBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            } else if(state === 'cancelled') {
                if(statusEl) statusEl.textContent = statusLabels.cancelled;
                if(icon) icon.className = 'fa-solid fa-ban text-zinc-400';
                if(cancelBtn) cancelBtn.disabled = true;
            }
        }

        function handlePyEvent(data) {
            if(!data || !data.task_id) return;
            if(data.type === 'title') {
                const el = document.getElementById('title-' + data.task_id);
                if(el) el.innerText = data.title;
            }
            if(data.type === 'status') {
                const label = statusLabels[data.status] || data.status;
                updateStatus(data.task_id, label);
            }
            if(data.type === 'progress') {
                updateProgress(data.task_id, data.progress || 0);
                if(data.status) updateStatus(data.task_id, statusLabels[data.status] || data.status);
            }
            if(data.type === 'done') {
                updateStatus(data.task_id, statusLabels.done);
                setCardState(data.task_id, 'done', {path: data.path});
            }
            if(data.type === 'error') {
                setCardState(data.task_id, 'error', {message: data.error || 'Error'});
            }
            if(data.type === 'finished') {
                if(data.cancelled) {
                    setCardState(data.task_id, 'cancelled');
                }
            }
        }

        function openResult(id) {
            const btn = document.getElementById('open-' + id);
            if(!btn || btn.disabled) return;
            const targetPath = btn.dataset.path;
            if(targetPath) {
                pywebview.api.open_path(targetPath);
            }
        }

        function cancelTask(id) {
            const btn = document.getElementById('cancel-' + id);
            if(btn) btn.disabled = true;
            pywebview.api.cancel_download(id).then(res => {
                if(res.status !== 'ok' && btn) btn.disabled = false;
            });
        }
    </script>
</body>
</html>
