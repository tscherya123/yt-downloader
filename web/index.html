<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* GLOBAL */
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #0b0b0d; color: #f4f4f5; user-select: none; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #18181b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 8px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }
        .drag-handle { -webkit-app-region: drag; }
        .no-drag { -webkit-app-region: no-drag; }

        /* TOGGLES */
        .toggle { position: relative; width: 48px; height: 26px; display: inline-block; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #3f3f46; transition: 0.3s; border-radius: 9999px; }
        .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background: #d4d4d8; transition: 0.3s; border-radius: 9999px; box-shadow: 0 6px 14px rgba(0,0,0,0.4); }
        .toggle input:checked + .toggle-slider { background: linear-gradient(90deg, #4f46e5, #8b5cf6); }
        .toggle input:checked + .toggle-slider:before { transform: translateX(22px); background: white; }

        /* RANGE PREVIEW */
        .trim-track { position: relative; height: 6px; background: #1f1f24; border-radius: 999px; }
        .trim-fill { position: absolute; height: 100%; background: linear-gradient(90deg, #4f46e5, #8b5cf6); border-radius: 999px; left: 0%; width: 100%; top: 0; }
        .trim-handle { position: absolute; top: 50%; transform: translate(-50%, -50%); width: 18px; height: 18px; background: white; border-radius: 999px; border: 3px solid #6366f1; box-shadow: 0 6px 16px rgba(0,0,0,0.45); cursor: pointer; z-index: 10; }
        .trim-handle.active { cursor: grabbing; }

        @keyframes shimmer {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        .progress-shimmer { background-size: 200% 100%; animation: shimmer 2s ease-in-out infinite; }

        /* BUTTONS */
        .action-icon-btn { width: 2.5rem; height: 2.5rem; border-radius: 0.75rem; background: #202023; border: 1px solid #3f3f46; color: #d4d4d8; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        .action-icon-btn:hover { border-color: #6366f1; color: #e5e7eb; }
        .action-icon-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* STATES */
        .border-active { border-color: #eab308 !important; animation: pulse-border 2s infinite; box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.35); }
        .border-queued { border-color: #f97316 !important; }
        .card-cancelled { opacity: 0.6; filter: grayscale(100%); }

        @keyframes pulse-border {
            0% { border-color: #a16207; box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.35); }
            50% { border-color: #facc15; box-shadow: 0 0 0 12px rgba(234, 179, 8, 0); }
            100% { border-color: #a16207; box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.35); }
        }

        @keyframes progress-indeterminate {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        .progress-indeterminate {
            background-image: linear-gradient(135deg, rgba(255, 241, 138, 0.25) 25%, rgba(99, 102, 241, 0.5) 25%, rgba(99, 102, 241, 0.5) 50%, rgba(255, 241, 138, 0.25) 50%, rgba(255, 241, 138, 0.25) 75%, rgba(99, 102, 241, 0.5) 75%);
            background-size: 200% 100%;
            animation: progress-indeterminate 1.5s linear infinite;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden border border-zinc-800 rounded-2xl">
    <!-- TITLE BAR -->
    <div class="h-11 bg-[#1a1a1f] border-b border-zinc-800 flex items-center justify-between px-4 drag-handle pywebview-drag-region">
        <div class="flex items-center gap-2 text-sm text-zinc-200">
            <i class="fa-solid fa-cloud-arrow-down text-indigo-500"></i>
            <span class="font-semibold">Video Downloader</span>
        </div>
        <div class="flex items-center gap-3 no-drag">
            <button onclick="pywebview.api.minimize_window()" class="text-zinc-500 hover:text-white" style="-webkit-app-region: no-drag;"><i class="fa-solid fa-minus"></i></button>
            <button onclick="pywebview.api.toggle_fullscreen()" class="text-zinc-500 hover:text-white" style="-webkit-app-region: no-drag;"><i class="fa-regular fa-square"></i></button>
            <button onclick="pywebview.api.close_window()" class="text-zinc-500 hover:text-red-500" style="-webkit-app-region: no-drag;"><i class="fa-solid fa-xmark"></i></button>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="flex flex-1 min-h-0 overflow-hidden bg-[#0f0f11]">
        <!-- SIDEBAR -->
        <aside class="w-[420px] bg-[#18181b] border-r border-zinc-800 p-6 flex flex-col gap-5 overflow-y-auto">
            <div>
                <label class="text-xs font-bold text-zinc-500 uppercase mb-2 block">ДЖЕРЕЛО</label>
                <div class="relative flex items-center gap-2">
                    <div class="relative flex-1">
                        <i class="fa-solid fa-link text-zinc-500 absolute left-3 top-1/2 -translate-y-1/2"></i>
                        <input id="url-input" type="text" placeholder="Вставте посилання..." class="w-full bg-[#27272a] border border-zinc-700 rounded-lg py-3 pl-10 pr-3 text-sm text-white focus:border-indigo-500 outline-none">
                    </div>
                    <button id="btn-search" onclick="searchVideo()" class="h-[46px] px-4 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-white text-sm font-semibold flex items-center gap-2 shadow-lg transition">
                        <i id="search-icon" class="fa-solid fa-magnifying-glass"></i>
                        <i id="search-spinner" class="fa-solid fa-spinner animate-spin hidden"></i>
                        <span>Пошук</span>
                    </button>
                </div>
            </div>

            <div>
                <label class="text-xs font-bold text-zinc-500 uppercase mb-2 block">ЗБЕРЕГТИ В</label>
                <div class="relative flex items-center gap-2">
                    <div class="relative flex-1">
                        <i class="fa-solid fa-folder text-zinc-500 absolute left-3 top-1/2 -translate-y-1/2"></i>
                        <input id="path-input" type="text" readonly class="w-full bg-[#27272a] border border-zinc-700 rounded-lg py-3 pl-10 pr-3 text-sm text-zinc-400 cursor-default" placeholder="Оберіть папку">
                    </div>
                    <button id="btn-folder" onclick="chooseFolder()" class="action-icon-btn" title="Оберіть папку">
                        <i class="fa-solid fa-ellipsis"></i>
                    </button>
                </div>
            </div>

            <div class="bg-[#202023] border border-zinc-800 rounded-2xl p-4 space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-zinc-200">Конвертувати в MP4</span>
                    <label class="toggle">
                        <input type="checkbox" id="chk-mp4" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-zinc-200">Послідовне завантаження</span>
                    <label class="toggle">
                        <input type="checkbox" id="chk-queue">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="bg-[#202023] border border-zinc-800 rounded-2xl overflow-hidden shadow-lg" id="preview-card">
                <div id="preview-placeholder" class="bg-[#1f1f24] border border-dashed border-zinc-700 text-zinc-500 flex items-center justify-center text-sm aspect-video">
                    Введіть посилання, щоб побачити прев'ю відео
                </div>
                <div id="preview-loaded" class="hidden">
                    <div class="bg-[#0f0f11] relative flex items-center justify-center aspect-video w-full">
                        <img id="preview-thumb" alt="Прев'ю" class="w-full h-full object-cover bg-black">
                        <span id="preview-duration" class="absolute bottom-3 right-4 text-xs bg-[#0b0b0d] border border-zinc-700 text-white px-2 py-1 rounded-md">--:--</span>
                    </div>
                    <div class="p-4 space-y-3">
                        <div>
                            <div id="preview-title" class="text-sm font-semibold truncate text-white"></div>
                            <div class="text-xs text-zinc-500 mt-1 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-green-500"></span>
                                <span>Готово до завантаження</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-xs text-zinc-500">
                                <span id="time-start-label">00:00</span>
                                <span id="time-end-label">--:--</span>
                            </div>
                            <div id="trim-slider" class="relative">
                                <div id="trim-track" class="trim-track">
                                    <div id="trim-fill" class="trim-fill"></div>
                                    <span id="handle-start" class="trim-handle"></span>
                                    <span id="handle-end" class="trim-handle"></span>
                                </div>
                            </div>
                            <div class="flex justify-between text-xs text-zinc-500">
                                <span>Початок</span>
                                <span>Кінець</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between text-sm text-zinc-400 border-t border-zinc-800 pt-3">
                            <div class="flex items-center gap-2">
                                <i class="fa-brands fa-youtube text-red-400"></i>
                                <span>Підтримується</span>
                            </div>
                            <span class="text-xs text-indigo-300">HD</span>
                        </div>
                    </div>
                </div>
            </div>

            <button id="btn-download" onclick="initiateDownload()" disabled class="mt-auto w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-semibold py-3 rounded-2xl transition shadow-lg shadow-purple-800/30 flex justify-center items-center gap-2 text-sm opacity-50 cursor-not-allowed">
                <i class="fa-solid fa-download"></i>
                Завантажити
            </button>
        </aside>

        <!-- MAIN PANEL -->
        <main class="flex-1 bg-[#121212] flex flex-col px-6 py-5 overflow-hidden min-h-0">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <h2 class="text-lg font-semibold">Черга завантажень</h2>
                    <span id="queue-count" class="px-2 py-1 rounded-full bg-[#1f1f24] border border-zinc-800 text-xs text-zinc-300">0</span>
                </div>
                <button onclick="clearAll()" class="text-xs text-zinc-500 hover:text-white flex items-center gap-1">
                    <i class="fa-solid fa-trash-can"></i>
                    <span>Очистити історію</span>
                </button>
            </div>

            <div id="download-list" class="flex-1 overflow-y-auto space-y-3 pr-1"></div>
        </main>
    </div>

    <!-- STATUS BAR -->
    <footer class="h-8 shrink-0 bg-[#18181b] border-t border-zinc-800 px-5 flex items-center justify-between text-xs text-zinc-400">
        <div class="flex items-center gap-3">
            <div id="footer-checking" class="flex items-center gap-2 text-indigo-300">
                <span class="w-2 h-2 bg-indigo-400 rounded-full animate-pulse"></span>
                <span>Перевірка оновлень...</span>
            </div>
            <div id="footer-ready" class="hidden items-center gap-2 text-green-400">
                <span class="w-2 h-2 bg-green-400 rounded-full"></span>
                <span>Готовий</span>
            </div>
            <button id="footer-update-button" onclick="startUpdate()" class="hidden items-center gap-2 text-orange-300 border border-orange-500/60 bg-orange-500/10 hover:bg-orange-500/20 px-3 py-1 rounded-lg text-xs font-semibold animate-pulse">
                <i id="footer-update-spinner" class="fa-solid fa-rotate fa-spin hidden"></i>
                <span id="footer-update-text">Натисніть, щоб оновити</span>
            </button>
            <span class="text-zinc-500">Версія <span id="app-version">loading...</span></span>
        </div>
    <div class="flex items-center gap-4 text-zinc-500">
        <span>UA</span>
        <span>Dark Theme</span>
    </div>
    </footer>

    <div id="update-overlay" class="fixed inset-0 z-50 bg-black/90 hidden">
        <div class="h-full w-full flex items-center justify-center p-6">
            <div class="w-full max-w-lg bg-[#141418] border border-zinc-800 rounded-2xl p-6 shadow-2xl space-y-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-orange-500/20 border border-orange-400/50 flex items-center justify-center text-orange-300">
                        <i class="fa-solid fa-rotate"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold">Оновлення...</h3>
                        <p id="update-status-text" class="text-sm text-zinc-400">Завантаження...</p>
                    </div>
                </div>
                <div class="w-full h-3 bg-[#1f1f24] rounded-full overflow-hidden border border-zinc-800">
                    <div id="update-progress-bar" class="h-full bg-gradient-to-r from-orange-400 via-amber-300 to-yellow-400 progress-shimmer transition-all duration-300" style="width: 0%;"></div>
                </div>
                <div class="flex items-center justify-between text-sm text-zinc-400">
                    <span>Прогрес</span>
                    <span id="update-progress-label">0%</span>
                </div>
                <div class="flex items-center justify-end gap-2">
                    <button id="update-restart-btn" class="hidden px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-semibold" onclick="restartManually()">Перезапустити</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const statusLabels = {
            downloading: 'Завантаження...',
            converting: 'Конвертація...',
            done: 'Завершено',
            cancelled: 'Скасовано',
            queued: "В черзі...",
            error: 'Помилка',
            idle: 'Початок...'
        };

        const tasks = new Map();
        const settingsState = { root_folder: '', mp4: true, sequential: false };
        let currentMetadata = null;
        let trimSlider = null;
        const updateState = { status: 'checking', availableVersion: null };
        const ICON_BUTTON_CLASS = 'action-icon-btn';
        const PROGRESS_BASE_CLASS = 'h-full bg-gradient-to-r from-indigo-600 to-purple-600 transition-all duration-300';
        const PROGRESS_CANCELLED_CLASS = 'h-full bg-zinc-600 transition-all duration-300';

        function formatTime(seconds) {
            const totalSeconds = Math.max(0, Math.floor(Number(seconds) || 0));
            const hrs = Math.floor(totalSeconds / 3600);
            const mins = Math.floor((totalSeconds % 3600) / 60);
            const secs = totalSeconds % 60;

            const baseTime = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            if (hrs > 0) {
                return `${hrs}:${baseTime}`;
            }
            return baseTime;
        }

        class VideoSlider {
            constructor() {
                this.slider = document.getElementById('trim-slider');
                this.track = document.getElementById('trim-track');
                this.fill = document.getElementById('trim-fill');
                this.handleStart = document.getElementById('handle-start');
                this.handleEnd = document.getElementById('handle-end');
                this.duration = 0;
                this.start = 0;
                this.end = 0;
                this.activeHandle = null;
                this.minGapSeconds = 0.25;

                if (this.handleStart && this.handleEnd) {
                    ['mousedown', 'touchstart'].forEach(evt => {
                        this.handleStart.addEventListener(evt, (e) => this.startDrag(e, 'start'));
                        this.handleEnd.addEventListener(evt, (e) => this.startDrag(e, 'end'));
                    });
                    ['mousemove', 'touchmove'].forEach(evt => document.addEventListener(evt, (e) => this.onDrag(e)));
                    ['mouseup', 'touchend', 'touchcancel'].forEach(evt => document.addEventListener(evt, () => this.stopDrag()));
                }

                this.updateUI();
            }

            init(durationSeconds) {
                this.duration = Math.max(0, Number(durationSeconds) || 0);
                this.start = 0;
                this.end = this.duration;
                this.updateUI();
            }

            reset() {
                this.duration = 0;
                this.start = 0;
                this.end = 0;
                this.updateUI();
            }

            startDrag(event, handle) {
                if (!this.track || this.duration <= 0) return;
                event.preventDefault();
                this.activeHandle = handle;
                if (handle === 'start' && this.handleStart) this.handleStart.classList.add('active');
                if (handle === 'end' && this.handleEnd) this.handleEnd.classList.add('active');
                this.onDrag(event);
            }

            onDrag(event) {
                if (!this.activeHandle || !this.track || this.duration <= 0) return;
                const clientX = event.touches?.[0]?.clientX ?? event.clientX;
                const rect = this.track.getBoundingClientRect();
                const rawPercent = (clientX - rect.left) / rect.width;
                const clampedPercent = Math.min(1, Math.max(0, rawPercent));
                const seconds = clampedPercent * this.duration;

                if (this.activeHandle === 'start') {
                    this.start = Math.min(seconds, this.end - this.minGapSeconds);
                    this.start = Math.max(0, this.start);
                } else if (this.activeHandle === 'end') {
                    this.end = Math.max(seconds, this.start + this.minGapSeconds);
                    this.end = Math.min(this.duration, this.end);
                }

                this.updateUI();
            }

            stopDrag() {
                this.activeHandle = null;
                if (this.handleStart) this.handleStart.classList.remove('active');
                if (this.handleEnd) this.handleEnd.classList.remove('active');
            }

            updateUI() {
                if (!this.slider || !this.track || !this.fill || !this.handleStart || !this.handleEnd) return;

                const startPercent = this.duration > 0 ? (this.start / this.duration) * 100 : 0;
                const endPercent = this.duration > 0 ? (this.end / this.duration) * 100 : 100;
                const left = Math.min(startPercent, endPercent);
                const width = Math.max(endPercent - startPercent, 0);

                this.handleStart.style.left = `${startPercent}%`;
                this.handleEnd.style.left = `${endPercent}%`;
                this.fill.style.left = `${left}%`;
                this.fill.style.width = `${width}%`;

                const startLabel = document.getElementById('time-start-label');
                const endLabel = document.getElementById('time-end-label');

                if (startLabel) startLabel.textContent = formatTime(this.start);
                if (endLabel) endLabel.textContent = this.duration > 0 ? formatTime(this.end) : '--:--';
            }

            getSelection() {
                return { start: this.start, end: this.end, duration: this.duration };
            }
        }

        window.addEventListener('load', () => {
            resetPreview();

            trimSlider = new VideoSlider();

            const mp4Toggle = document.getElementById('chk-mp4');
            const queueToggle = document.getElementById('chk-queue');

            if (mp4Toggle) {
                mp4Toggle.addEventListener('change', (e) => {
                    settingsState.mp4 = e.target.checked;
                    pywebview?.api?.update_setting?.('mp4', settingsState.mp4);
                });
            }

            if (queueToggle) {
                queueToggle.addEventListener('change', (e) => {
                    settingsState.sequential = e.target.checked;
                    pywebview?.api?.update_setting?.('sequential', settingsState.sequential);
                });
            }
        });

        window.addEventListener('pywebviewready', function() {
            if (pywebview?.api?.get_init_data) {
                pywebview.api.get_init_data().then(initApp).catch((err) => {
                    console.error(err);
                    const versionEl = document.getElementById('app-version');
                    if (versionEl) versionEl.textContent = '—';
                });
            }
        });

        function initApp(data) {
            const versionEl = document.getElementById('app-version');
            if (versionEl) versionEl.textContent = data?.version || '—';

            const mp4Toggle = document.getElementById('chk-mp4');
            const queueToggle = document.getElementById('chk-queue');

            if (data?.settings) {
                const folder = data.settings.root_folder;
                const pathInput = document.getElementById('path-input');
                const resolvedFolder = folder || 'Default (Downloads)';

                if (pathInput) {
                    const currentValue = pathInput.value?.trim();
                    pathInput.value = currentValue && currentValue !== 'Оберіть папку' ? currentValue : resolvedFolder;
                }

                if (mp4Toggle) mp4Toggle.checked = Boolean(data.settings.mp4);
                if (queueToggle) queueToggle.checked = Boolean(data.settings.sequential);

                settingsState.root_folder = resolvedFolder;
                settingsState.mp4 = Boolean(data.settings.mp4);
                settingsState.sequential = Boolean(data.settings.sequential);
            }

            if (Array.isArray(data?.history)) {
                data.history.forEach(task => registerTask(task));
            }

            setFooterChecking();
        }

        function setSearchLoading(isLoading) {
            const btn = document.getElementById('btn-search');
            const icon = document.getElementById('search-icon');
            const spinner = document.getElementById('search-spinner');
            if (!btn || !icon || !spinner) return;
            btn.disabled = isLoading;
            btn.classList.toggle('opacity-50', isLoading);
            btn.classList.toggle('cursor-not-allowed', isLoading);
            icon.classList.toggle('hidden', isLoading);
            spinner.classList.toggle('hidden', !isLoading);
        }

        function setDownloadButtonDisabled(disabled) {
            const btn = document.getElementById('btn-download');
            if (!btn) return;
            btn.disabled = disabled;
            btn.classList.toggle('opacity-50', disabled);
            btn.classList.toggle('cursor-not-allowed', disabled);
        }

        function resetPreview() {
            currentMetadata = null;
            const placeholder = document.getElementById('preview-placeholder');
            const loaded = document.getElementById('preview-loaded');
            if (placeholder) placeholder.classList.remove('hidden');
            if (loaded) loaded.classList.add('hidden');

            const titleEl = document.getElementById('preview-title');
            const durationEl = document.getElementById('preview-duration');
            const endEl = document.getElementById('time-end-label');
            const thumb = document.getElementById('preview-thumb');

            if (titleEl) titleEl.textContent = '';
            if (durationEl) durationEl.textContent = '--:--';
            if (endEl) endEl.textContent = '--:--';
            if (thumb) thumb.src = '';

            if (trimSlider) trimSlider.reset();
            setDownloadButtonDisabled(true);
        }

        function chooseFolder() {
            pywebview.api.select_folder().then(p => {
                if (p) {
                    document.getElementById('path-input').value = p;
                    settingsState.root_folder = p;
                    pywebview?.api?.update_setting?.('root_folder', p);
                }
            });
        }

        function searchVideo() {
            const url = document.getElementById('url-input').value.trim();
            if (!url) return alert('Будь ласка, введіть посилання');

            setSearchLoading(true);
            pywebview.api.fetch_metadata(url).then(res => {
                setSearchLoading(false);
                if (res.status === 'ok') {
                    currentMetadata = { ...res, url };
                    applyMetadata(res);
                    setDownloadButtonDisabled(false);
                } else {
                    alert(res.error || 'Не вдалося отримати метадані');
                    resetPreview();
                }
            }).catch(() => {
                setSearchLoading(false);
                alert('Не вдалося отримати метадані');
                resetPreview();
            });
        }

        function applyMetadata(meta) {
            const placeholder = document.getElementById('preview-placeholder');
            const loaded = document.getElementById('preview-loaded');
            if (placeholder) placeholder.classList.add('hidden');
            if (loaded) loaded.classList.remove('hidden');

            const titleEl = document.getElementById('preview-title');
            const durationEl = document.getElementById('preview-duration');
            const endEl = document.getElementById('time-end-label');
            const thumb = document.getElementById('preview-thumb');
            const durationSeconds = Number(meta.duration) || 0;

            if (titleEl) titleEl.textContent = meta.title || 'Без назви';
            if (durationEl) durationEl.textContent = meta.duration_str || '00:00';
            if (endEl) endEl.textContent = meta.duration_str || formatTime(durationSeconds);
            if (thumb) thumb.src = meta.thumbnail || '';

            if (trimSlider) trimSlider.init(durationSeconds);
        }

        function updateQueueCount() {
            document.getElementById('queue-count').textContent = tasks.size;
        }

        function clearAll() {
            if (!pywebview?.api?.get_queue_stats) {
                tasks.clear();
                document.getElementById('download-list').innerHTML = '';
                updateQueueCount();
                return;
            }

            pywebview.api.get_queue_stats().then(stats => {
                const active = Number(stats?.active) || 0;
                const message = active > 0
                    ? `Увага! Зараз завантажується ${active} файлів. Ви впевнені, що хочете скасувати їх та очистити історію?`
                    : 'Видалити всю історію? Файли залишаться на диску.';
                if (!confirm(message)) return null;
                return pywebview.api.perform_clear();
            }).then(res => {
                if (res?.status === 'ok') {
                    tasks.clear();
                    const list = document.getElementById('download-list');
                    if (list) list.innerHTML = '';
                    updateQueueCount();
                }
            }).catch(() => {});
        }

        function initiateDownload() {
            const url = document.getElementById('url-input').value.trim();
            const path = document.getElementById('path-input').value.trim();
            const mp4 = document.getElementById('chk-mp4').checked;

            const selection = trimSlider?.getSelection?.();
            const startSeconds = selection && selection.duration > 0 ? selection.start : 0;
            const endSeconds = selection && selection.duration > 0 ? selection.end : (currentMetadata?.duration || 0);

            if (!url) return alert('Будь ласка, введіть посилання');

            const titleHint = (currentMetadata && currentMetadata.title) || document.getElementById('preview-title').textContent.trim();

            pywebview.api.start_download(url, path, { mp4: mp4, sequential: settingsState.sequential, start_seconds: startSeconds, end_seconds: endSeconds }, titleHint).then(res => {
                if (res.status === 'ok') {
                    const label = titleHint || url;
                    registerTask({ id: res.task_id, title: label, url, status: 'downloading', path: '', error: '' });
                    document.getElementById('url-input').value = '';
                    resetPreview();
                } else {
                    alert(res.message || res.error || 'Не вдалося ініціювати завантаження');
                }
            }).catch(() => {
                alert('Не вдалося ініціювати завантаження');
            });
        }

        function registerTask(task) {
            if (!task?.id) return;
            const normalized = {
                id: task.id,
                title: task.title || task.url || task.id,
                url: task.url || '',
                status: task.status || 'downloading',
                path: task.path || '',
                error: task.error || ''
            };
            tasks.set(normalized.id, normalized);
            createTaskCard(normalized);
            setCardState(normalized);
            updateQueueCount();
        }

        function createTaskCard(task) {
            const existing = document.getElementById(`card-${task.id}`);
            if (existing) {
                document.getElementById(`title-${task.id}`).textContent = task.title;
                return;
            }

            const list = document.getElementById('download-list');
            const card = document.createElement('div');
            card.id = `card-${task.id}`;
            card.className = 'bg-[#18181b] border border-zinc-800 rounded-2xl p-4 shadow-lg transition relative overflow-hidden';
            card.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 rounded-full bg-[#24242a] border border-zinc-700 flex items-center justify-center text-indigo-400" id="icon-${task.id}">
                        <i class="fa-solid fa-cloud-arrow-down"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-start justify-between gap-2">
                            <div class="min-w-0">
                                <h4 class="text-sm font-semibold text-white truncate" id="title-${task.id}">${task.title}</h4>
                                <div class="text-xs text-zinc-500 mt-1" id="status-${task.id}">${statusLabels[task.status] || statusLabels.idle}</div>
                            </div>
                            <div id="actions-${task.id}" class="flex items-center gap-2"></div>
                        </div>
                        <div class="flex justify-between items-center mt-2 text-xs text-zinc-500">
                            <span id="speed-${task.id}">Підготовка до завантаження...</span>
                            <span class="font-mono text-indigo-300" id="percent-${task.id}">0%</span>
                        </div>
                    </div>
                </div>
                <div class="mt-3 w-full bg-[#202023] h-2 rounded-full overflow-hidden">
                    <div id="prog-${task.id}" class="${PROGRESS_BASE_CLASS}" style="width: 0%"></div>
                </div>
            `;
            list.insertAdjacentElement('afterbegin', card);
        }

        function updateProgress(id, percent, speedText) {
            const bar = document.getElementById('prog-' + id);
            const label = document.getElementById('percent-' + id);
            const speed = document.getElementById('speed-' + id);
            const numeric = Number(percent);

            if (Number.isFinite(numeric) && numeric < 0) {
                if (bar) {
                    bar.style.width = '100%';
                    bar.classList.add('progress-indeterminate');
                }
                if (label) label.innerHTML = '<i class="fa-solid fa-hourglass-half"></i>';
                if (speed) speed.textContent = 'Обробка потоку... (прогрес невідомий)';
                return;
            }

            const value = Number.isFinite(numeric) ? Math.min(Math.max(numeric, 0), 100) : 0;

            if (bar) {
                bar.style.width = `${value}%`;
                bar.classList.remove('progress-indeterminate');
            }
            if (label) label.textContent = `${Math.round(value)}%`;
            if (speed) speed.textContent = speedText ?? '';
        }

        function setCardState(task) {
            const id = task.id;
            const card = document.getElementById('card-' + id);
            const icon = document.getElementById('icon-' + id);
            const statusEl = document.getElementById('status-' + id);
            const bar = document.getElementById('prog-' + id);
            if (!card) return;

            card.classList.remove('card-cancelled', 'opacity-50', 'pointer-events-none', 'grayscale');
            card.classList.remove('border-green-500/40', 'border-red-500/40', 'border-amber-400/50', 'border-active', 'border-queued');
            if (statusEl) statusEl.className = 'text-xs text-zinc-500 mt-1';
            if (bar) {
                const preserveIndeterminate = bar.classList.contains('progress-indeterminate');
                bar.className = PROGRESS_BASE_CLASS + (preserveIndeterminate ? ' progress-indeterminate' : '');
            }

            if (task.status === 'done') {
                updateProgress(id, 100);
                card.classList.add('border-green-500/40');
                if (statusEl) {
                    statusEl.className = 'text-xs text-green-400';
                    statusEl.textContent = statusLabels.done;
                }
                if (icon) icon.innerHTML = '<i class="fa-solid fa-circle-check text-green-500"></i>';
            } else if (task.status === 'error') {
                card.classList.add('border-red-500/40');
                if (statusEl) {
                    statusEl.className = 'text-xs text-red-400';
                    statusEl.textContent = task.error || statusLabels.error;
                }
                if (icon) icon.innerHTML = '<i class="fa-solid fa-triangle-exclamation text-red-400"></i>';
            } else if (task.status === 'cancelled') {
                card.classList.add('card-cancelled');
                updateProgress(id, 100);
                if (bar) bar.className = PROGRESS_CANCELLED_CLASS;
                if (statusEl) statusEl.textContent = statusLabels.cancelled;
                if (icon) icon.innerHTML = '<i class="fa-solid fa-ban text-zinc-400"></i>';
            } else if (task.status === 'queued') {
                card.classList.add('border-queued');
                if (statusEl) {
                    statusEl.className = 'text-xs text-amber-300 mt-1';
                    statusEl.textContent = statusLabels.queued;
                }
                if (icon) icon.innerHTML = '<i class="fa-solid fa-clock text-amber-300"></i>';
            } else {
                if (statusEl) statusEl.textContent = statusLabels[task.status] || statusLabels.idle;
                if (icon) icon.innerHTML = '<i class="fa-solid fa-cloud-arrow-down"></i>';
            }

            if (['downloading', 'converting'].includes(task.status)) {
                card.classList.add('border-active');
            }

            updateActions(task);
        }

        function handleUpdateEvent(event) {
            if (!event?.type) return;
            if (event.type === 'update_checking') {
                setFooterChecking();
                return;
            }
            if (event.type === 'update_not_found') {
                setFooterReady();
                hideUpdateOverlay();
                return;
            }
            if (event.type === 'update_available') {
                updateState.availableVersion = event.version || null;
                setFooterUpdateAvailable(event.version);
                hideUpdateOverlay();
                return;
            }
            if (event.type === 'update_progress') {
                const progressValue = Math.max(0, Math.min(100, Number(event.progress) || 0));
                const stage = event.stage === 'install' ? 'install' : 'download';
                showUpdateOverlay(stage);
                setUpdateProgress(progressValue);
                return;
            }
            if (event.type === 'update_ready') {
                showUpdateOverlay('install');
                setUpdateProgress(100);
                setUpdateStatusText('Завершення...');
                return;
            }
            if (event.type === 'update_error') {
                hideUpdateOverlay();
                setFooterReady();
                if (event.error) {
                    alert(`Помилка оновлення: ${event.error}`);
                }
            }
        }

        function handlePyEvent(data) {
            if (data?.type && data.type.startsWith('update')) {
                handleUpdateEvent(data);
                return;
            }

            if (!data || !data.task_id) return;
            const task = tasks.get(data.task_id) || { id: data.task_id, title: data.title || data.task_id, url: '', status: 'downloading', path: '', error: '' };
            tasks.set(task.id, task);

            if (data.type === 'title' && data.title) {
                task.title = data.title;
                const el = document.getElementById('title-' + data.task_id);
                if (el) el.innerText = data.title;
            }
            if (data.type === 'status') {
                task.status = data.status;
            }
            if (data.type === 'progress') {
                updateProgress(data.task_id, data.progress || 0, data.speed);
                if (data.status) task.status = data.status;
            }
            if (data.type === 'done') {
                task.status = 'done';
                task.path = data.path || task.path;
            }
            if (data.type === 'error') {
                task.status = 'error';
                task.error = data.error || '';
            }
            if (data.type === 'finished' && data.cancelled) {
                task.status = 'cancelled';
            }

            createTaskCard(task);
            setCardState(task);
            updateQueueCount();
        }

        function setFooterChecking() {
            updateState.status = 'checking';
            const checking = document.getElementById('footer-checking');
            const ready = document.getElementById('footer-ready');
            const btn = document.getElementById('footer-update-button');
            checking?.classList.remove('hidden');
            ready?.classList.add('hidden');
            btn?.classList.add('hidden');
        }

        function setFooterReady() {
            updateState.status = 'ready';
            const checking = document.getElementById('footer-checking');
            const ready = document.getElementById('footer-ready');
            const btn = document.getElementById('footer-update-button');
            checking?.classList.add('hidden');
            ready?.classList.remove('hidden');
            btn?.classList.add('hidden');
            const spinner = document.getElementById('footer-update-spinner');
            spinner?.classList.add('hidden');
        }

        function setFooterUpdateAvailable(version) {
            updateState.status = 'available';
            updateState.availableVersion = version || null;
            const checking = document.getElementById('footer-checking');
            const ready = document.getElementById('footer-ready');
            const btn = document.getElementById('footer-update-button');
            const text = document.getElementById('footer-update-text');
            checking?.classList.add('hidden');
            ready?.classList.add('hidden');
            if (text) text.textContent = version ? `Натисніть, щоб оновити до v${version}` : 'Натисніть, щоб оновити';
            btn?.classList.remove('hidden');
            btn?.classList.add('animate-pulse');
        }

        function startUpdate() {
            const btn = document.getElementById('footer-update-button');
            const spinner = document.getElementById('footer-update-spinner');
            if (btn) {
                btn.classList.remove('animate-pulse');
                btn.classList.add('opacity-80');
            }
            spinner?.classList.remove('hidden');
            showUpdateOverlay('download');
            setUpdateProgress(0);
            pywebview?.api?.perform_update?.();
        }

        function showUpdateOverlay(stage = 'download') {
            const overlay = document.getElementById('update-overlay');
            overlay?.classList.remove('hidden');
            setUpdateStatusText(stage === 'install' ? 'Розпаковка...' : 'Завантаження...');
        }

        function hideUpdateOverlay() {
            const overlay = document.getElementById('update-overlay');
            overlay?.classList.add('hidden');
        }

        function setUpdateStatusText(text) {
            const el = document.getElementById('update-status-text');
            if (el) el.textContent = text;
        }

        function setUpdateProgress(value) {
            const bar = document.getElementById('update-progress-bar');
            const label = document.getElementById('update-progress-label');
            const percent = Math.max(0, Math.min(100, Number(value) || 0));
            if (bar) bar.style.width = `${percent}%`;
            if (label) label.textContent = `${percent}%`;
        }

        function restartManually() {
            pywebview?.api?.close_window?.();
        }

        function openFolder(id) {
            const task = tasks.get(id);
            const path = task?.path || settingsState.root_folder;
            if (path) {
                pywebview.api.open_folder(path);
            }
        }

        function playFile(id) {
            const task = tasks.get(id);
            if (task?.path) {
                pywebview.api.open_file(task.path);
            }
        }

        function cancelTask(id) {
            const card = document.getElementById('card-' + id);
            const bar = document.getElementById('prog-' + id);
            if (card) card.classList.add('card-cancelled');
            if (bar) {
                bar.className = PROGRESS_CANCELLED_CLASS;
                bar.style.width = '100%';
            }
            pywebview.api.cancel_download(id);
        }

        function removeTask(id) {
            const card = document.getElementById('card-' + id);
            if (card) card.remove();
            tasks.delete(id);
            updateQueueCount();
            pywebview?.api?.remove_task?.(id);
        }

        function openUrl(url) {
            if (!url) return;
            if (pywebview?.api?.open_url) {
                pywebview.api.open_url(url);
            } else {
                window.open(url, '_blank');
            }
        }

        function retrySearch(url) {
            if (!url) return;
            document.getElementById('url-input').value = url;
            searchVideo();
        }

        function retryTask(id) {
            const task = tasks.get(id);
            if (task?.url) {
                retrySearch(task.url);
            }
        }

        function createIconButton(iconClass, handler, options = {}) {
            const btn = document.createElement('button');
            btn.className = `${ICON_BUTTON_CLASS} ${options.extraClasses || ''}`;
            btn.innerHTML = `<i class="${iconClass}"></i>`;
            if (options.title) btn.title = options.title;
            btn.onclick = handler;
            if (options.disabled) {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            return btn;
        }

        function createTextButton(iconClass, label, handler, options = {}) {
            const btn = document.createElement('button');
            btn.className = `px-3 py-2 rounded-xl text-xs border border-zinc-700 text-zinc-300 bg-[#202023] flex items-center gap-2 ${options.extraClasses || ''}`;
            btn.innerHTML = `<i class="${iconClass}"></i><span>${label}</span>`;
            btn.onclick = handler;
            if (options.disabled) {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            return btn;
        }

        function updateActions(task) {
            const container = document.getElementById(`actions-${task.id}`);
            if (!container) return;

            container.innerHTML = '';
            const actions = [];

            if (task.status === 'queued') {
                actions.push(createTextButton('fa-solid fa-clock', 'В черзі...', () => {}, { disabled: true, extraClasses: 'text-amber-300 border-amber-400/60' }));
                actions.push(createIconButton('fa-solid fa-xmark', () => cancelTask(task.id), { title: 'Скасувати', extraClasses: 'text-red-400 hover:text-red-300 hover:border-red-400/60' }));
                actions.push(createIconButton('fa-solid fa-link', () => openUrl(task.url), { title: 'Відкрити посилання' }));
            } else if (['downloading', 'converting'].includes(task.status)) {
                actions.push(createIconButton('fa-solid fa-xmark', () => cancelTask(task.id), { title: 'Скасувати', extraClasses: 'text-red-400 hover:text-red-300 hover:border-red-400/60' }));
                actions.push(createIconButton('fa-solid fa-link', () => openUrl(task.url), { title: 'Відкрити посилання' }));
            } else if (['error', 'cancelled'].includes(task.status)) {
                actions.push(createIconButton('fa-solid fa-rotate-right', () => retrySearch(task.url), { title: 'Спробувати ще' }));
                actions.push(createIconButton('fa-solid fa-link', () => openUrl(task.url), { title: 'Відкрити посилання' }));
                actions.push(createIconButton('fa-solid fa-trash-can', () => removeTask(task.id), { title: 'Видалити', extraClasses: 'hover:text-red-400 hover:border-red-400/60' }));
            } else if (task.status === 'done') {
                actions.push(createTextButton('fa-regular fa-folder-open', 'Папка', () => openFolder(task.id), {
                    disabled: !task.path,
                    extraClasses: 'hover:border-zinc-500 transition-colors'
                }));
                actions.push(createIconButton('fa-solid fa-play', () => playFile(task.id), { disabled: !task.path, title: 'Відтворити' }));
                actions.push(createIconButton('fa-solid fa-link', () => openUrl(task.url), { title: 'Відкрити посилання' }));
                actions.push(createIconButton('fa-solid fa-rotate-right', () => retryTask(task.id), { title: 'Спробувати ще' }));
                actions.push(createIconButton('fa-solid fa-trash-can', () => removeTask(task.id), { title: 'Видалити', extraClasses: 'hover:text-red-400 hover:border-red-400/60' }));
            } else {
                actions.push(createIconButton('fa-solid fa-link', () => openUrl(task.url), { title: 'Відкрити посилання' }));
                actions.push(createIconButton('fa-solid fa-trash-can', () => removeTask(task.id), { title: 'Видалити', extraClasses: 'hover:text-red-400 hover:border-red-400/60' }));
            }

            actions.forEach(btn => container.appendChild(btn));
        }
    </script>
</body>
</html>
