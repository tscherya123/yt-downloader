# Інструкції для агентів

## Загальні вимоги
- Перед комітом переконайтесь, що локально проходить `pytest` (у CI використовується саме він).
- Підтримуйте типові залежності проєкту: Python 3.11, `customtkinter`, `yt-dlp`, `Pillow`, `pyinstaller`, `pytest`.
- Користувачі запускають застосунок як Windows `.exe`. Уникайте змін, які ламають роботу у зібраному виконуваному файлі, та відстежуйте всі місця, де використовується `sys.frozen`, `resolve_asset_path` чи `resolve_executable`.
- При додаванні нових файлів або ресурсів переконайтесь, що вони зможуть бути знайдені після збирання PyInstaller (через `resolve_asset_path`/`resolve_executable`) і, за потреби, додайте їх до PyInstaller команд у workflow.

## Архітектура застосунку
- Головна логіка UI міститься у `yt_downloader/app.py`, а CLI-сумісна точка входу — `ui.py`. Зміни в цих файлах повинні зберігати роботу черги завантажень (`DownloadWorker` + `TaskRow`) і не блокувати головний потік Tkinter: будь-які довгі операції мають виконуватися у потоках (`DownloadWorker`).
- Робота з `yt-dlp` інкапсульована в `yt_downloader/backend.py`. Підтримуйте обидва режими: імпорт модуля та fallback до зовнішнього `yt-dlp.exe` (важливо для PyInstaller білда).
- Допоміжні утиліти (`yt_downloader/utils.py`) надають функції для роботи з файлами, URL та пошуку виконуваних файлів/ресурсів. При зміні їх поведінки обов'язково оновіть пов’язані тести.
- Автоматичні оновлення реалізовані пакетами `yt_downloader/updates.py`, `yt_downloader/updater.py` та `yt_downloader/relauncher.py`. Підтримуйте сумісність цих модулів з процесом самовідновлення `.exe` та не видаляйте журнали/файли, які потрібні для діагностики (`update_log_path`).

## Пакування та GitHub Actions
- Workflow `.github/workflows/release.yml` збирає застосунок за допомогою PyInstaller (цілі `yt-downloader.exe` та `yt-downloader-relauncher.exe`) і пакує `ffmpeg.exe`/`ffprobe.exe`. Будь-які зміни залежностей, ресурсів або шляху до скриптів вимагатимуть оновлення цього workflow.
- Команда PyInstaller має всі необхідні `--add-data`. Якщо додаєте нові ресурси (іконки, локалізацію, теми), синхронізуйте список у workflow, інакше вони не потраплять у фінальний `.exe`.
- Якщо змінюється спосіб запуску застосунку, оновіть також `start_ui.bat` та логіку `build_updater_command`/`maybe_run_updater`.
- Пам’ятайте, що workflow автоматично інкрементує версію у `yt_downloader/__init__.py` та `yt_downloader/version.py`. Якщо переносите константу версії, синхронізуйте шлях у скрипті `Increment version`.

## Локалізація
- Локалізаційні рядки зберігаються у `yt_downloader/localization.py`. Будь-який новий текстовий ключ необхідно додати для всіх підтримуваних мов (`SUPPORTED_LANGUAGES`: `uk`, `en`). Не залишайте `None` або порожніх значень — тести не ловлять цього автоматично, тому перевіряйте вручну.
- В інтерфейсі використовуйте лише `translate("key")` або `self._t(...)`, не хардкодуйте рядки. Під час оновлення ключів шукайте використання через `rg "key"` та синхронізуйте переклади.

## Теми й оформлення
- Тема за замовчуванням та палітри визначені у `yt_downloader/themes.py`. Додаючи нову тему, оновіть `_PALETTES`, `THEMES`, а також переконайтесь, що у `DownloaderUI` правильно вибирається значення (`resolve_theme`).
- Для нових кольорів або токенів палітри впевніться, що їх споживає код UI (наприклад, властивості `background`, `muted`, `accent`). Уникайте хардкоду відтінків у виджетах: використовуйте `self.current_palette`.

## Оновлення та релончер
- `yt_downloader/updates.py` відповідає за пошук релізів на GitHub та вибір активу. Якщо змінюється формат релізів чи назви файлів, оновіть функцію `select_preferred_asset` та пов’язані тести.
- `yt_downloader/updater.py` виконує заміну виконуваного файлу. Зберігайте логіку ретраїв та резервних копій (`*.bak`). Якщо змінюєте шлях запуску або аргументи, синхронізуйте це з викликами у `app.py` (`build_updater_command`, `maybe_run_updater`).
- Релончер (`yt_downloader/relauncher.py`) повинен залишатися консольним-несумісним (використовується PyInstaller onefile). При додаванні опцій не забудьте оновити команду `pyinstaller` у workflow.

## Тестування
- Покриття тестами знаходиться у каталозі `tests/`. При зміні модулів оновлюйте або додавайте відповідні тести (наприклад, `test_updates.py` для логіки апдейтеру, `test_utils.py` для утиліт, `test_backend.py` для інтеграції з `yt-dlp`).
- Перед пушем намагайтесь запускати `pytest` у тому середовищі, де присутні основні залежності (Windows специфіка може не відловлюватися на Linux, тому перевіряйте обробку шляхів та файлових розширень вручну).

## Ресурси та статичні файли
- Іконки (`yt-dw-logo.ico`, `yt-dw-logo.png`) мають бути доступні через `resolve_asset_path`. Якщо додаєте нові зображення чи інші статичні ресурси, розмістіть їх у корені або пакеті `yt_downloader` і оновіть логіку пошуку, щоб підтримати режим PyInstaller.
- Не видаляйте та не перейменовуйте існуючі ресурси без повного оновлення посилань у коді, тестах та workflow.

Дотримання цих правил допоможе уникнути регресій у десктопному `.exe`, зберегти локалізацію/теми узгодженими та спростить підтримку автоматичних оновлень.
